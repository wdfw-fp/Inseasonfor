---
title: "Inseason Bonneville Dam Chinook salmon passage predictions"
output:
  html_document: 
    toc: true
    toc_float: true
    number_sections: false
    theme: cosmo
params:
  use_dev_version: true
---

```{=html}
<script>
$(document).ready(function() {
$head = $('#header');
$head.prepend('<img src=\"https://privatelands.wdfw.wa.gov/wdfwlogo_clrnotxt.png"\" style=\"float: right;width: 150px;\"/>')
});
</script>
```

------------------------------------------------------------------------

Last updated `r format(Sys.time(), '%m/%d/%Y')`.

------------------------------------------------------------------------

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)

if (params$use_dev_version) {
  pkgload::load_all(".")
  # } else {
  # library(Inseasonfor)
}


```

```{r data, message=FALSE, warning=FALSE}

# Bonneville counts
Bon_cnts <- data.frame()
num_tries_Bon_cnts <- 0
max_tries <- 6

while (num_tries_Bon_cnts < max_tries) {
  
  # Try to get and filter the data
  attempt <- try(
    bon_dat_fun(
      pred_date = NULL,
      url = "https://www.fpc.org/adults/R_coeadultcount_runsum",
      past_bon_cnts = past_bon_cnts
    ) |> 
    dplyr::filter(month >= 3),
    silent = TRUE
  )
  
  # If successful and non-empty, store and break
  if (is.data.frame(attempt) && nrow(attempt) > 0) {
    Bon_cnts <- attempt
    break
  }
  
  # Increment tries
  num_tries_Bon_cnts <- num_tries_Bon_cnts + 1
}

# Warn if all attempts failed
if (nrow(Bon_cnts) == 0) {
  warning(sprintf(
    "Failed to get Bonneville counts after %d attempts.",
    max_tries
  ))
}

forecastdate <- Bon_cnts |> dplyr::pull(CountDate) |>  max()#
forecast_season<-chk_season(forecastdate)
forecast_year<-lubridate::year(forecastdate)
forecast_month<-lubridate::month(forecastdate)
forecast_md<-lubridate::mday(forecastdate)


season_dates<-data.frame(season=c("spring","summer","fall"),
                         start_m=c("Mar","Jun","Aug"),
                         start_md=c(1,16,1),
                         end_m=c("Jun","Jul","Oct"),
                         end_md=c(15,31,30))




## Flow temp data
flow_temp_dat <- data.frame()
num_tries_flow_temp_dat <- 0
max_tries <- 6

while (num_tries_flow_temp_dat < max_tries) {
  
  # Try to get the data
  attempt <- try(
    get_flow_data(forecastdate = forecastdate, flow_file = past_flow_dat),
    silent = TRUE
  )
  
  # If successful and it's a non-empty data frame, store and break
  if (is.data.frame(attempt) && nrow(attempt) > 0) {
    flow_temp_dat <- attempt
    flow_temp_dat<-flow_temp_dat|> flow_ema_fun()
    break
  }
  
  # Increment tries
  num_tries_flow_temp_dat <- num_tries_flow_temp_dat + 1
}

# If all attempts failed, warn the user
if (nrow(flow_temp_dat) == 0) {
  warning(sprintf(
    "Failed to get flow data after %d attempts.",
    max_tries
  ))
}




# Fall split counts
Fall_split_cnts <- data.frame()
num_tries_Fall_split_cnts <- 0
max_tries <- 6

while (num_tries_Fall_split_cnts < max_tries) {
  
  # Try to get the data
  attempt <- try(
    tule_bright_split(forecastdate),
    silent = TRUE
  )
  
  # If successful and non-empty, store and break
  if (is.data.frame(attempt) && nrow(attempt) > 0) {
    Fall_split_cnts <- attempt
    break
  }
  
  # Increment tries
  num_tries_Fall_split_cnts <- num_tries_Fall_split_cnts + 1
}

# Warn if all attempts failed
if (nrow(Fall_split_cnts) == 0) {
  warning(sprintf(
    "Failed to get Fall split counts after %d attempts.",
    max_tries
  ))
}

  

```






```{r plots_n_stuff, echo=FALSE, results='asis',warning=FALSE,message=FALSE}
cat("# {.tabset}","\n\n")


for (season_i in c("spring","summer","fall")){#
  
  seas_end<-(season_dates |> dplyr::filter(season==season_i) |> 
               dplyr::select(end_m, end_md) |> paste(collapse=" ") |> paste(forecast_year,collapse=",") |> lubridate::mdy())
  
  
  seas_start<-(season_dates |> dplyr::filter(season==season_i) |> 
                 dplyr::select(start_m, start_md) |> paste(collapse=" ") |> paste(forecast_year,collapse=",") |> lubridate::mdy())
  
  
  #if forecast date greater than the season end date
  if (forecastdate>seas_end){
    forecastdate_i<-seas_end
    ##set date to last day of season
    
  }else{
    
    forecastdate_i<-forecastdate
  }
  
  
  #if forecast date less than the season start date
  ## leave date as is but do not run plotting functions, only blurb. Another option would be to show last years' results in this case. 
  
  
  
  
  
  
  cat("## ",season_i,ifelse(season_i==forecast_season,"{.active}",""),"\n\n")
  
  
  
  if (forecastdate <
      as.Date(ifelse(season_i=="spring",as.Date(paste0(forecast_year,"-03-01")),
                     ifelse(season_i=="summer",as.Date(paste0(forecast_year,"-06-16")),
                            ifelse(season_i=="fall",as.Date(paste0(forecast_year,"-08-01"))))))){
    
    cat(sprintf("**The %s %s season starts %s. Below are results from %s**", forecast_year,season_i,
                (season_dates |> dplyr::filter(season==season_i) |> dplyr::select(start_m,start_md) |> paste(collapse=" ")),(forecast_year-1)),"\n\n")
    
    #set date to last day of previous year
   forecastdate_i<-seas_end<- (season_dates |> dplyr::filter(season==season_i) |> 
               dplyr::select(end_m, end_md) |> paste(collapse=" ") |> paste((forecast_year-1),collapse=",") |> lubridate::mdy())
    
  } #else {
    
    
    #  if(forecastdate_i<=forecastdate){
    #    
    if(season_i=="fall"){
      
      cat("During the fall season, we partition  adult Chinook counts into bright adults, tule adults, and tule stubbies based on a visual assessment of the number of fish of each class passing the dam during two hours of the day. These visual assignments are subject to error and are a tool for inseason forecasting but not post-season run reconstruction. The predictions below are based on these visual assesments.","\n\n")
      
      cat("### {.tabset}","\n\n")
      
      for (morph in c("Tule","Bright")){
        
        cat("#### ",morph,"\n\n")
        
        
        
        render_tab(pred_date=forecastdate_i,
                   counts=Fall_split_cnts,
                   river_env=flow_temp_dat,
                   do_plots=(forecastdate_i>=seas_start),
                   seas_dats=season_dates,
                   seas_end=seas_end,
                   write_local=params$use_dev_version,
                   morph=morph)
        
      }
      cat("## {-}","\n\n")
      
    } else {
      
      
      render_tab(pred_date=forecastdate_i,
                 counts=Bon_cnts,
                 river_env=flow_temp_dat,
                 do_plots=(forecastdate_i>=seas_start),
                 seas_dats=season_dates,
                 seas_end=seas_end,
                 write_local=params$use_dev_version,
                 morph="")
      
      
    }
  # }
  
}

cat("# {-}","\n\n")
```


## Data sources

Fish counts are accessed from the [Fish Passage Center](https://www.fpc.org) and river environment data from the [US Army Corps of Engineers Northwest District](https://www.nwd-wc.usace.army.mil/dd/common/dataquery/www/?k=bonneville)

Fall season visual estimates of tule and bright passage are available from [data.wa.gov](https://data.wa.gov/en/Natural-Resources-Environment/WDFW-Bonneville-Dam-observations/w52y-hhyj/about_data)

## Additional resources

**Columbia Basin Research** produces spring and fall Chinook run size predictions available [here](https://www.cbr.washington.edu/inseason/adult).

[This site](https://oscrpapps.shinyapps.io/TAC-Inseason-Preds-sh/) shows **spring Chinook run size predictions from ODFW** based on a log-linear regression between end-of-season dam counts and 2 predictors: 1) the total jack dam counts from the previous year, and 2) the cumulative adult counts to date.

[This site](https://oscrpapps.shinyapps.io/tac-inseason-preds-sox/) shows **sockeye run size predictions from ODFW**.


Data from **test fishing** is available [here](https://wdfw.wa.gov/fishing/management/columbia-river/research/test-fishing)

A plethora of information including pre-season **forecasts and fact sheet** with catch updates is available [here](https://wdfw.wa.gov/fishing/management/columbia-river/compact). Note that pre-season forecasts are generally of an index of abundance that includes the Bonneville Dam counts and harvest below Bonneville Dam, so a greater number than what is being predicted here.

**Code** used to generate predictions and render website is available [here](https://github.com/wdfw-fp/Inseasonfor)
